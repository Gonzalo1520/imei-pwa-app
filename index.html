
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IMEI OCR App</title>
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body style="font-family:sans-serif; text-align:center; padding:20px;">
  <h2>Captura AutomÃ¡tica IMEI</h2>
  <video id="video" width="300" height="225" autoplay style="border:1px solid black;"></video>
  <br>
  <button onclick="tomarFoto()">ðŸ“¸ Escanear ahora</button>
  <canvas id="canvas" style="display:none;"></canvas>
  <p id="estado">Esperando escaneo...</p>

  <table border="1" id="tablaIMEI" style="margin: 20px auto; border-collapse: collapse;">
    <tr>
      <th>#</th>
      <th>Empresa</th>
      <th>TelÃ©fono</th>
      <th>IMEI Equipo</th>
      <th>IMEI Chip</th>
    </tr>
  </table>

  <button onclick="exportarExcel()">ðŸ“¤ Exportar a Excel</button>

  <script>
    let registros = [];
    let contador = 1;

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => { video.srcObject = stream; })
      .catch(err => { document.getElementById("estado").innerText = "No se pudo acceder a la cÃ¡mara."; });

    function agregarRegistro(empresa, telefono, imeiEquipo, imeiChip) {
      registros.push([contador, empresa, telefono, imeiEquipo, imeiChip]);
      let fila = document.createElement("tr");
      fila.innerHTML = `<td>${contador}</td><td>${empresa}</td><td>${telefono}</td><td>${imeiEquipo}</td><td>${imeiChip}</td>`;
      document.getElementById("tablaIMEI").appendChild(fila);
      contador++;
    }

    function exportarExcel() {
      let wb = XLSX.utils.book_new();
      let ws = XLSX.utils.aoa_to_sheet([["#", "Empresa", "TelÃ©fono", "IMEI Equipo", "IMEI Chip"], ...registros]);
      XLSX.utils.book_append_sheet(wb, ws, "Registros");
      XLSX.writeFile(wb, "Registro_IMEIs.xlsx");
    }

    function tomarFoto() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      document.getElementById("estado").innerText = "Procesando imagen...";

      canvas.toBlob(blob => {
        Tesseract.recognize(blob, 'eng', { logger: m => console.log(m) })
          .then(({ data: { text } }) => {
            document.getElementById("estado").innerText = "Procesado.";

            let empresa = "";
            let telefono = "";
            let imeiEquipo = "";
            let imeiChip = "";

            let empresaMatch = text.match(/.*SAC.*/i);
            if (empresaMatch) empresa = empresaMatch[0].trim();

            let telefonoMatch = text.match(/9\d{8}/);
            if (telefonoMatch) telefono = telefonoMatch[0];

            let imeiMatch = text.match(/\b\d{14,20}\b/g);
            if (imeiMatch) {
              imeiMatch.forEach(n => {
                if (n.startsWith("89")) imeiChip = n;
                else imeiEquipo = n;
              });
            }

            if (imeiEquipo || imeiChip) {
              agregarRegistro(empresa, telefono, imeiEquipo, imeiChip);
            } else {
              document.getElementById("estado").innerText = "No se encontraron IMEIs.";
            }
          });
      }, 'image/jpeg');
    }

    // PWA - Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('serviceWorker.js')
        .then(() => console.log("Service Worker registrado"))
        .catch(err => console.error("Error registrando Service Worker:", err));
    }
  </script>
</body>
</html>
