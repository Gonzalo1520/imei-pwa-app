<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IMEI OCR App Pro</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', sans-serif; 
      text-align: center; 
      padding: 10px; 
      margin: 0; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: white;
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
      background: rgba(255,255,255,0.1); 
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    h2 { 
      margin-bottom: 30px; 
      font-size: 28px; 
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .camera-container { 
      position: relative; 
      display: inline-block; 
      margin-bottom: 20px;
    }
    video { 
      width: 100%; 
      max-width: 500px; 
      height: auto; 
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .overlay { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%);
      border: 2px solid #00ff00; 
      width: 80%; 
      height: 40%; 
      border-radius: 10px;
      pointer-events: none;
      opacity: 0.7;
    }
    .scan-buttons { 
      margin: 20px 0; 
      display: flex; 
      flex-wrap: wrap; 
      justify-content: center; 
      gap: 10px;
    }
    button { 
      padding: 12px 24px; 
      font-size: 16px; 
      border: none; 
      border-radius: 25px; 
      cursor: pointer; 
      transition: all 0.3s ease;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .btn-primary { 
      background: linear-gradient(45deg, #4CAF50, #45a049); 
      color: white; 
    }
    .btn-secondary { 
      background: linear-gradient(45deg, #2196F3, #1976D2); 
      color: white; 
    }
    .btn-debug { 
      background: linear-gradient(45deg, #FF9800, #F57C00); 
      color: white; 
    }
    .btn-export { 
      background: linear-gradient(45deg, #9C27B0, #7B1FA2); 
      color: white; 
    }
    button:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    button:disabled { 
      opacity: 0.6; 
      cursor: not-allowed; 
      transform: none;
    }
    .status { 
      margin: 20px 0; 
      padding: 15px; 
      border-radius: 10px; 
      font-weight: 600; 
      font-size: 16px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .status.processing { 
      background: rgba(255, 193, 7, 0.2); 
      border: 2px solid #FFC107;
      animation: pulse 2s infinite;
    }
    .status.success { 
      background: rgba(76, 175, 80, 0.2); 
      border: 2px solid #4CAF50;
    }
    .status.error { 
      background: rgba(244, 67, 54, 0.2); 
      border: 2px solid #F44336;
    }
    .status.idle { 
      background: rgba(255, 255, 255, 0.1); 
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #45a049);
      width: 0%;
      transition: width 0.3s ease;
    }
    table { 
      margin: 20px auto; 
      border-collapse: collapse; 
      width: 100%; 
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    th, td { 
      padding: 12px 8px; 
      font-size: 14px; 
      text-align: center; 
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    th { 
      background: rgba(255,255,255,0.2); 
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    tr:hover { 
      background: rgba(255,255,255,0.1); 
    }
    .debug-panel { 
      background: rgba(0,0,0,0.8); 
      padding: 15px; 
      margin: 20px 0; 
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      text-align: left;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .preview-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .preview-item {
      background: rgba(255,255,255,0.1);
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .preview-item h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
    }
    .preview-item canvas {
      width: 100%;
      height: auto;
      border-radius: 5px;
    }
    .scan-tips {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      border-left: 4px solid #4CAF50;
      text-align: left;
    }
    .scan-tips h4 {
      margin: 0 0 10px 0;
      color: #4CAF50;
    }
    .scan-tips ul {
      margin: 0;
      padding-left: 20px;
    }
    .scan-tips li {
      margin: 5px 0;
      font-size: 14px;
    }
    @media (max-width: 600px) {
      .scan-buttons { flex-direction: column; align-items: center; }
      button { width: 200px; }
      th, td { font-size: 12px; padding: 8px 4px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>üîç IMEI Scanner Pro</h2>
    
    <div class="camera-container">
      <video id="video" autoplay playsinline></video>
      <div class="overlay" id="overlay"></div>
    </div>
    
    <div class="scan-buttons">
      <button class="btn-primary" onclick="iniciarEscaneo('equipo')" id="btnEquipo">
        üì± Escanear EQUIPO
      </button>
      <button class="btn-secondary" onclick="iniciarEscaneo('chip')" id="btnChip">
        üì≤ Escanear CHIP/SIM
      </button>
      <button class="btn-debug" onclick="toggleDebug()" id="btnDebug">
        üîç Debug
      </button>
    </div>

    <div class="status idle" id="estado">
      <span>üì∑ Listo para escanear</span>
      <div class="progress-bar" id="progressBar" style="display:none;">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>

    <div class="scan-tips" id="scanTips" style="display:none;">
      <h4>üí° Consejos para mejor escaneo:</h4>
      <ul id="tipsList"></ul>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>
    
    <div id="debugPanel" class="debug-panel" style="display:none;">
      <h4>üîß Panel de Debug</h4>
      <div id="debugInfo"></div>
      <div class="preview-container" id="previewContainer"></div>
    </div>

    <table id="tablaIMEI">
      <thead>
        <tr>
          <th>#</th>
          <th>Empresa</th>
          <th>Tel√©fono</th>
          <th>IMEI Equipo</th>
          <th>IMEI Chip</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody id="tablaBody"></tbody>
    </table>

    <div class="scan-buttons">
      <button class="btn-export" onclick="exportarExcel()" id="btnExport">
        üì§ Exportar Excel
      </button>
      <button class="btn-secondary" onclick="limpiarTabla()">
        üóëÔ∏è Limpiar
      </button>
    </div>
  </div>

  <script>
    let registros = [];
    let contador = 1;
    let escaneoActual = '';
    let debugMode = false;
    let isProcessing = false;
    let worker = null;

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const estado = document.getElementById('estado');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');

    // Inicializar Tesseract Worker
    async function initTesseract() {
      try {
        worker = await Tesseract.createWorker('eng');
        await worker.setParameters({
          tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ.-',
          tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
        });
        updateStatus('‚úÖ Sistema listo', 'success');
      } catch (error) {
        updateStatus('‚ùå Error inicializando OCR', 'error');
        console.error('Error init Tesseract:', error);
      }
    }

    // Inicializar c√°mara
    async function initCamera() {
      try {
        const constraints = {
          video: {
            facingMode: "environment",
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        return true;
      } catch (error) {
        updateStatus('‚ùå No se pudo acceder a la c√°mara', 'error');
        console.error('Error camera:', error);
        return false;
      }
    }

    function updateStatus(message, type = 'idle', showProgress = false) {
      estado.className = `status ${type}`;
      estado.querySelector('span').textContent = message;
      progressBar.style.display = showProgress ? 'block' : 'none';
      if (!showProgress) {
        progressFill.style.width = '0%';
      }
    }

    function updateProgress(percent) {
      progressFill.style.width = `${percent}%`;
    }

    function toggleDebug() {
      debugMode = !debugMode;
      document.getElementById('debugPanel').style.display = debugMode ? 'block' : 'none';
      document.getElementById('scanTips').style.display = debugMode ? 'block' : 'none';
      document.getElementById('btnDebug').textContent = debugMode ? 'üîç Debug ON' : 'üîç Debug OFF';
    }

    function mostrarTips(tipo) {
      const tips = {
        equipo: [
          'Coloca el equipo sobre una superficie plana',
          'Aseg√∫rate de que la etiqueta est√© bien iluminada',
          'Mant√©n la c√°mara estable',
          'La etiqueta debe estar dentro del marco verde'
        ],
        chip: [
          'Usa buena iluminaci√≥n directa',
          'Acerca la c√°mara al chip/SIM',
          'Evita reflejos en la superficie del chip',
          'Mant√©n el chip completamente plano',
          'Los n√∫meros deben verse n√≠tidos'
        ]
      };
      
      const tipsList = document.getElementById('tipsList');
      tipsList.innerHTML = '';
      tips[tipo].forEach(tip => {
        const li = document.createElement('li');
        li.textContent = tip;
        tipsList.appendChild(li);
      });
    }

    async function iniciarEscaneo(tipo) {
      if (isProcessing) return;
      
      escaneoActual = tipo;
      isProcessing = true;
      mostrarTips(tipo);
      
      // Deshabilitar botones
      document.getElementById('btnEquipo').disabled = true;
      document.getElementById('btnChip').disabled = true;
      
      updateStatus('üì∏ Capturando imagen...', 'processing', true);
      updateProgress(20);
      
      // Esperar un momento para que el usuario se prepare
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      try {
        await tomarFoto();
      } catch (error) {
        updateStatus('‚ùå Error en el escaneo', 'error');
        console.error('Error escaneo:', error);
      } finally {
        isProcessing = false;
        document.getElementById('btnEquipo').disabled = false;
        document.getElementById('btnChip').disabled = false;
      }
    }

    function aplicarFiltros(canvas, context, tipo) {
      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      
      // Filtro espec√≠fico seg√∫n el tipo
      if (tipo === 'chip') {
        // Para chips: mayor contraste y enfoque en n√∫meros
        for (let i = 0; i < data.length; i += 4) {
          const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
          const contrast = gray > 140 ? 255 : gray < 60 ? 0 : gray;
          data[i] = contrast;
          data[i + 1] = contrast;
          data[i + 2] = contrast;
        }
      } else {
        // Para equipos: procesamiento m√°s suave
        for (let i = 0; i < data.length; i += 4) {
          const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
          const enhanced = gray > 128 ? Math.min(255, gray * 1.2) : Math.max(0, gray * 0.8);
          data[i] = enhanced;
          data[i + 1] = enhanced;
          data[i + 2] = enhanced;
        }
      }
      
      context.putImageData(imageData, 0, 0);
      return canvas;
    }

    async function tomarFoto() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      updateProgress(40);
      
      // Crear m√∫ltiples versiones procesadas
      const originalCanvas = canvas.cloneNode();
      const originalContext = originalCanvas.getContext('2d');
      originalContext.drawImage(canvas, 0, 0);
      
      const processedCanvas = aplicarFiltros(canvas, context, escaneoActual);
      
      updateStatus('üß† Procesando con OCR...', 'processing', true);
      updateProgress(60);
      
      // Mostrar previews si est√° en debug
      if (debugMode) {
        mostrarPreviews(originalCanvas, processedCanvas);
      }
      
      try {
        const blob = await new Promise(resolve => {
          processedCanvas.toBlob(resolve, 'image/jpeg', 0.95);
        });
        
        updateProgress(80);
        
        const { data: { text, confidence } } = await worker.recognize(blob);
        
        updateProgress(100);
        
        if (debugMode) {
          mostrarDebugInfo(text, confidence);
        }
        
        if (escaneoActual === 'equipo') {
          await procesarEquipo(text);
        } else if (escaneoActual === 'chip') {
          await procesarChip(text);
        }
        
      } catch (error) {
        updateStatus('‚ùå Error en OCR: ' + error.message, 'error');
        console.error('Error OCR:', error);
      }
    }

    function mostrarPreviews(original, processed) {
      const container = document.getElementById('previewContainer');
      container.innerHTML = '';
      
      const createPreview = (canvas, title) => {
        const item = document.createElement('div');
        item.className = 'preview-item';
        item.innerHTML = `<h4>${title}</h4>`;
        
        const previewCanvas = document.createElement('canvas');
        previewCanvas.width = 200;
        previewCanvas.height = 150;
        const previewContext = previewCanvas.getContext('2d');
        previewContext.drawImage(canvas, 0, 0, 200, 150);
        
        item.appendChild(previewCanvas);
        container.appendChild(item);
      };
      
      createPreview(original, 'Original');
      createPreview(processed, 'Procesada');
    }

    function mostrarDebugInfo(text, confidence) {
      const debugInfo = document.getElementById('debugInfo');
      debugInfo.innerHTML = `
        <p><strong>Confianza OCR:</strong> ${confidence.toFixed(2)}%</p>
        <p><strong>Texto detectado:</strong></p>
        <pre>${text}</pre>
        <p><strong>L√≠neas limpias:</strong></p>
        <pre>${text.split('\n').map(line => line.trim()).filter(line => line.length > 0).join('\n')}</pre>
      `;
    }

    async function procesarEquipo(text) {
      const resultados = {
        empresa: extraerEmpresa(text),
        telefono: extraerTelefono(text),
        imei: extraerIMEI(text)
      };
      
      if (resultados.imei) {
        agregarRegistro(resultados.empresa, resultados.telefono, resultados.imei, '');
        await enviarAGoogleSheet({ ...resultados, imeiChip: '' });
        updateStatus(`‚úÖ IMEI Equipo: ${resultados.imei}`, 'success');
      } else {
        updateStatus('‚ùå No se encontr√≥ IMEI del equipo', 'error');
      }
    }

    async function procesarChip(text) {
      const iccid = extraerICCID(text);
      
      if (iccid) {
        agregarRegistro('', '', '', iccid);
        await enviarAGoogleSheet({ empresa: '', telefono: '', imeiEquipo: '', imeiChip: iccid });
        updateStatus(`‚úÖ ICCID: ${iccid}`, 'success');
      } else {
        updateStatus('‚ùå No se encontr√≥ ICCID del chip', 'error');
      }
    }

    function extraerEmpresa(text) {
      const patterns = [
        /.*SAC.*/i,
        /.*EMPRESA.*/i,
        /.*CORP.*/i,
        /.*S\.A\.C\.*/i
      ];
      
      for (const pattern of patterns) {
        const match = text.match(pattern);
        if (match) return match[0].trim();
      }
      return '';
    }

    function extraerTelefono(text) {
      const patterns = [
        /9\d{8}/g,
        /\+51\s*9\d{8}/g,
        /\(51\)\s*9\d{8}/g
      ];
      
      for (const pattern of patterns) {
        const match = text.match(pattern);
        if (match) return match[0].replace(/\D/g, '').slice(-9);
      }
      return '';
    }

    function extraerIMEI(text) {
      // Buscar exactamente 15 d√≠gitos
      const imei15 = text.match(/\b\d{15}\b/g);
      if (imei15) return imei15[0];
      
      // Buscar 14-17 d√≠gitos como fallback
      const imeiRange = text.match(/\b\d{14,17}\b/g);
      if (imeiRange) return imeiRange[0];
      
      return '';
    }

    function extraerICCID(text) {
      // Limpiar texto
      const cleanText = text.replace(/\s+/g, '');
      
      // Buscar ICCID est√°ndar (empieza con 89)
      const iccidPattern = cleanText.match(/89\d{17,20}/);
      if (iccidPattern) return iccidPattern[0];
      
      // Buscar secuencias largas de n√∫meros
      const longNumbers = cleanText.match(/\d{18,22}/g);
      if (longNumbers) return longNumbers[0];
      
      // Buscar por l√≠neas
      const lines = text.split(/\n|\r/).map(l => l.trim().replace(/\s+/g, ''));
      for (const line of lines) {
        const cleanLine = line.replace(/[^\d]/g, '');
        if (cleanLine.length >= 18 && cleanLine.length <= 22) {
          return cleanLine;
        }
      }
      
      return '';
    }

    function agregarRegistro(empresa, telefono, imeiEquipo, imeiChip) {
      const fecha = new Date().toLocaleString('es-PE');
      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td>${contador}</td>
        <td>${empresa}</td>
        <td>${telefono}</td>
        <td>${imeiEquipo}</td>
        <td>${imeiChip}</td>
        <td>${fecha}</td>
      `;
      document.getElementById('tablaBody').appendChild(fila);
      
      registros.push([contador, empresa, telefono, imeiEquipo, imeiChip, fecha]);
      contador++;
    }

    async function enviarAGoogleSheet(data) {
      try {
        await fetch("https://script.google.com/macros/s/AKfycbw7licD0upxsFXRyHqGxSwD6uyyBkqzpI6I_yF-VlDG8Gv3fOHeJkuryePrwZm06WvYyw/exec", {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        console.log("‚úÖ Enviado a Google Sheets");
      } catch (error) {
        console.error("‚ùå Error Google Sheets:", error);
      }
    }

    function exportarExcel() {
      if (registros.length === 0) {
        updateStatus('‚ö†Ô∏è No hay registros para exportar', 'error');
        return;
      }
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet([
        ["#", "Empresa", "Tel√©fono", "IMEI Equipo", "IMEI Chip", "Fecha"], 
        ...registros
      ]);
      XLSX.utils.book_append_sheet(wb, ws, "Registros_IMEI");
      
      const fecha = new Date().toISOString().split('T')[0];
      XLSX.writeFile(wb, `IMEI_Registro_${fecha}.xlsx`);
      
      updateStatus('‚úÖ Excel exportado correctamente', 'success');
    }

    function limpiarTabla() {
      if (confirm('¬øEst√°s seguro de que quieres limpiar todos los registros?')) {
        registros = [];
        contador = 1;
        document.getElementById('tablaBody').innerHTML = '';
        updateStatus('üóëÔ∏è Tabla limpiada', 'success');
      }
    }

    // Inicializaci√≥n
    window.addEventListener('load', async () => {
      await initCamera();
      await initTesseract();
    });

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('serviceWorker.js');
    }
  </script>
</body>
</html>
